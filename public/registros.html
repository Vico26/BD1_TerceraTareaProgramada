<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registros</title>

<style>
    body {
        background-color: #2d2fa3;
        font-family: Arial, sans-serif;
        padding: 20px;
        margin: 0;
    }

    h1 {
        text-align: center;
        color: white;
        margin-bottom: 30px;
    }

    .panel {
        background: white;
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 8px;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .panel h2 {
        margin-top: 0;
        color: #303f9f;
    }

    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    input, select {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border-radius: 5px;
        border: 1px solid #bbb;
    }

    button {
        margin-top: 15px;
        padding: 12px 18px;
        background-color: #303f9f;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
    }

    button:hover {
        background-color: #1a237e;
    }

    .msg {
        margin-top: 10px;
        font-weight: bold;
    }
    
    .success {
        color: green;
    }
    
    .error {
        color: red;
    }
</style>
</head>

<body>

<h1>Panel de Registros</h1>

<div class="panel">
    <h2>Registrar Persona</h2>

    <label>Valor Documento Identidad</label>
    <input type="text" id="p_valorDocId">

    <label>Nombre Completo</label>
    <input type="text" id="p_nombre">

    <label>Email</label>
    <input type="text" id="p_email">

    <label>Teléfono</label>
    <input type="text" id="p_telefono">

    <label>Fecha Registro</label>
    <input type="date" id="p_fecha">

    <button onclick="registrarPersona()">Registrar Persona</button>

    <div id="msgPersona" class="msg"></div>
</div>

<div class="panel">
    <h2>Registrar Propiedad</h2>

    <label>Número de Finca</label>
    <input type="text" id="pr_finca">

    <label>Número de Medidor</label>
    <input type="text" id="pr_medidor">

    <label>Área (m²)</label>
    <input type="number" id="pr_area">

    <label>Tipo de Uso</label>
    <select id="pr_tipoUso"></select>

    <label>Tipo de Zona</label>
    <select id="pr_tipoZona"></select>

    <label>Valor Fiscal</label>
    <input type="number" id="pr_valorFiscal">

    <label>Fecha Registro</label>
    <input type="date" id="pr_fecha">

    <button onclick="registrarPropiedad()">Registrar Propiedad</button>

    <div id="msgPropiedad" class="msg"></div>
</div>

<div class="panel">
    <h2>Registrar Asociación Propiedad-Persona</h2>

    <label>Valor Documento Identidad</label>
    <input type="text" id="pp_valorDocId">

    <label>Número de Finca</label>
    <input type="text" id="pp_finca">

    <label>Tipo de Asociación</label>
    <select id="pp_tipoAso"></select>

    <label>Fecha Registro</label>
    <input type="date" id="pp_fecha">

    <button onclick="registrarAsociacion()">Registrar Asociación</button>

    <div id="msgAsociacion" class="msg"></div>
</div>

<script>

document.addEventListener("DOMContentLoaded", () => {
    cargarTipoUso();
    cargarTipoZona();
    cargarTipoAsociacion();   
});

async function cargarTipoUso() {
    try {
        const res = await fetch("/api/tipoUsoPropiedad");
        const data = await res.json();
        console.log("Tipo Uso:", data);

        let sel = document.getElementById("pr_tipoUso");
        sel.innerHTML = "";

        data.forEach(t => {
            sel.innerHTML += `<option value="${t.idTipoUso}">${t.Nombre}</option>`;
        });
    } catch (err) {
        console.error("Error cargando tipo uso:", err);
    }
}

async function cargarTipoAsociacion() {
    try {
        const res = await fetch("/api/tipoAsociacion");
        const data = await res.json();
        console.log("Tipo Asociacion:", data);

        let sel = document.getElementById("pp_tipoAso");
        sel.innerHTML = "";

        data.forEach(t => {
            sel.innerHTML += `<option value="${t.idTipoAso}">${t.Nombre}</option>`;
        });

    } catch (err) {
        console.error("Error cargando tipoAsociacion:", err);
    }
}

async function cargarTipoZona() {
    try {
        const res = await fetch("/api/tipoZonaPropiedad");
        const data = await res.json();
        console.log("Tipo Zona:", data);

        let sel = document.getElementById("pr_tipoZona");
        sel.innerHTML = "";

        data.forEach(t => {
            sel.innerHTML += `<option value="${t.idTipoZona}">${t.Nombre}</option>`;
        });
    } catch (err) {
        console.error("Error cargando tipo zona:", err);
    }
}

async function registrarPersona() {
    const msg = document.getElementById("msgPersona");
    msg.innerHTML = "Procesando...";
    msg.className = "msg";

    try {
        const payload = {
            valorDocId: document.getElementById("p_valorDocId").value,
            Nombre: document.getElementById("p_nombre").value,
            email: document.getElementById("p_email").value,
            telefono: document.getElementById("p_telefono").value,
            fechaRegistro: document.getElementById("p_fecha").value
        };

        console.log("Enviando persona:", payload);

        const res = await fetch("/api/registrarPersona", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();
        console.log("Respuesta persona:", data);

        if (data.success) {
            msg.innerHTML = "Persona registrada correctamente";
            msg.className = "msg success";
            // Limpiar formulario
            document.getElementById("p_valorDocId").value = "";
            document.getElementById("p_nombre").value = "";
            document.getElementById("p_email").value = "";
            document.getElementById("p_telefono").value = "";
            document.getElementById("p_fecha").value = "";
        } else {
            msg.innerHTML = "Error: " + (data.message || JSON.stringify(data));
            msg.className = "msg error";
        }
    } catch (err) {
        console.error("Error registrando persona:", err);
        msg.innerHTML = "Error de conexión: " + err.message;
        msg.className = "msg error";
    }
}

async function registrarPropiedad() {
    console.log("VERIFICACION: Estoy usando el archivo nuevo");
    
    const msg = document.getElementById("msgPropiedad");
    msg.innerHTML = "Procesando...";
    msg.className = "msg";

    try {
        const payload = {
            numeroFinca: document.getElementById("pr_finca").value,
            numeroMedidor: document.getElementById("pr_medidor").value,
            areaM2: parseInt(document.getElementById("pr_area").value) || 0,
            tipoUso: parseInt(document.getElementById("pr_tipoUso").value) || 0,
            tipoZona: parseInt(document.getElementById("pr_tipoZona").value) || 0,
            valorFiscal: parseFloat(document.getElementById("pr_valorFiscal").value) || 0,
            fechaRegistro: document.getElementById("pr_fecha").value
        };

        console.log("ENVIANDO propiedad:", payload);

        const res = await fetch("/api/registrarPropiedad", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();
        console.log("Respuesta propiedad:", data);

        if (data.success) {
            msg.innerHTML = "Propiedad registrada correctamente";
            msg.className = "msg success";
            // Limpiar formulario
            document.getElementById("pr_finca").value = "";
            document.getElementById("pr_medidor").value = "";
            document.getElementById("pr_area").value = "";
            document.getElementById("pr_valorFiscal").value = "";
            document.getElementById("pr_fecha").value = "";
        } else {
            msg.innerHTML = "Error: " + (data.message || JSON.stringify(data));
            msg.className = "msg error";
        }
    } catch (err) {
        console.error("Error registrando propiedad:", err);
        msg.innerHTML = "Error de conexión: " + err.message;
        msg.className = "msg error";
    }
}

async function registrarAsociacion() {
    const msg = document.getElementById("msgAsociacion");
    msg.innerHTML = "Procesando...";
    msg.className = "msg";

    try {
        const payload = {
            valorDocId: document.getElementById("pp_valorDocId").value,
            numeroFinca: document.getElementById("pp_finca").value,
            tipoAsoId: parseInt(document.getElementById("pp_tipoAso").value) || 0,
            fechaRegistro: document.getElementById("pp_fecha").value
        };

        console.log("Enviando asociación:", payload);

        const res = await fetch("/api/registrarPropiedadPersona", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();
        console.log("Respuesta asociación:", data);

        if (data.success) {
            msg.innerHTML = "Asociación registrada correctamente";
            msg.className = "msg success";
            // Limpiar formulario
            document.getElementById("pp_valorDocId").value = "";
            document.getElementById("pp_finca").value = "";
            document.getElementById("pp_fecha").value = "";
        } else {
            msg.innerHTML = "Error: " + (data.message || JSON.stringify(data));
            msg.className = "msg error";
        }
    } catch (err) {
        console.error("Error registrando asociación:", err);
        msg.innerHTML = "Error de conexión: " + err.message;
        msg.className = "msg error";
    }
}

</script>

</body>
</html>